<div class="container py-5">
    <div class="row">
        <div class="col-md-8">
            <h1 class="mb-3"><%= product.name %></h1>
            
            <% if (product.mainImage) { %>
                <img src="/admin/media/image/<%= product.mainImage._id %>/large" class="img-fluid rounded mb-4" alt="<%= product.name %>">
            <% } %>

            <% if (product.description) { %>
                <div class="mb-4">
                    <p class="lead"><%= product.description %></p>
                </div>
            <% } %>

            <% if (product.sizes && product.sizes.length > 0) { %>
                <div class="mb-4">
                    <h4 class="mb-3">Available Sizes</h4>
                    <div class="d-flex flex-wrap gap-2" id="sizesContainer">
                        <% product.sizes.forEach((size, index) => { %>
                            <button type="button" 
                                    class="btn btn-outline-primary size-btn" 
                                    data-size-name="<%= size.name %>"
                                    data-size-price="<%= size.price || '' %>"
                                    data-size-description="<%= size.description || '' %>"
                                    onclick="selectSize(this)">
                                <strong><%= size.name %></strong>
                                <% if (size.price) { %>
                                    - $<%= size.price.toFixed(2) %>
                                <% } %>
                                <% if (size.description) { %>
                                    <br><small class="text-muted"><%= size.description %></small>
                                <% } %>
                            </button>
                        <% }); %>
                    </div>
                    <div id="selectedSizes" class="mt-3" style="display: none;">
                        <h5>Selected Sizes:</h5>
                        <div id="selectedSizesList" class="d-flex flex-wrap gap-2 mb-2"></div>
                    </div>
                </div>
            <% } %>

            <% if (product.gallery && product.gallery.length > 0) { %>
                <h3 class="mt-5 mb-3">Product Gallery</h3>
                <div class="row g-3">
                    <% product.gallery.forEach(image => { %>
                        <div class="col-md-6">
                            <img src="/admin/media/image/<%= image._id %>/medium" class="img-fluid rounded" alt="Product gallery image">
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </div>
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Product Details</h5>
                    <hr>
                    <% if (product.startingAtPrice) { %>
                        <p class="mb-2"><strong>Starting At:</strong> $<%= product.startingAtPrice.toFixed(2) %></p>
                    <% } %>
                    <% if (product.manufacturer) { %>
                        <p class="mb-2"><strong>Manufacturer:</strong> <%= product.manufacturer %></p>
                    <% } %>
                    <% if (product.materials) { %>
                        <p class="mb-2"><strong>Materials:</strong> <%= product.materials %></p>
                    <% } %>
                    <% if (product.saltwaterCompatible) { %>
                        <p class="mb-2">
                            <strong>Saltwater Compatible:</strong> 
                            <span class="badge bg-success">Yes</span>
                        </p>
                    <% } %>
                    <hr>
                    <a href="/products" class="btn btn-primary w-100">Back to Products</a>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Request Information</h5>
                    <form action="/contact" method="POST" id="productContactForm">
                        <input type="hidden" name="from" value="product">
                        <input type="hidden" name="productId" value="<%= product._id %>">
                        <input type="hidden" name="productName" value="<%= product.name %>">
                        <input type="hidden" name="selectedSizes" id="selectedSizesInput" value="">

                        <div class="mb-3">
                            <label for="name" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone" name="phone">
                        </div>

                        <div class="mb-3">
                            <label for="town" class="form-label">Town</label>
                            <input type="text" class="form-control" id="town" name="town">
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason for Contact *</label>
                            <select class="form-select" id="reason" name="reason" required>
                                <option value="">Select a reason</option>
                                <option value="New Pool Consult">New Pool Consult</option>
                                <option value="Pool Replacement">Pool Replacement</option>
                                <option value="Liner Replacement">Liner Replacement</option>
                                <option value="Service Work">Service Work</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="message" class="form-label">Message *</label>
                            <textarea class="form-control" id="message" name="message" rows="4" required></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Send Inquiry</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedSizes = [];

function selectSize(button) {
    const sizeName = button.getAttribute('data-size-name');
    const sizePrice = button.getAttribute('data-size-price');
    const sizeDescription = button.getAttribute('data-size-description');
    
    const sizeData = {
        name: sizeName,
        price: sizePrice,
        description: sizeDescription
    };
    
    // Toggle selection
    const index = selectedSizes.findIndex(s => s.name === sizeName);
    if (index > -1) {
        // Remove if already selected
        selectedSizes.splice(index, 1);
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
    } else {
        // Add if not selected
        selectedSizes.push(sizeData);
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');
    }
    
    updateSelectedSizesDisplay();
}

function updateSelectedSizesDisplay() {
    const container = document.getElementById('selectedSizes');
    const list = document.getElementById('selectedSizesList');
    const input = document.getElementById('selectedSizesInput');
    
    if (selectedSizes.length > 0) {
        container.style.display = 'block';
        list.innerHTML = selectedSizes.map(size => {
            let priceText = size.price ? ` - $${parseFloat(size.price).toFixed(2)}` : '';
            return `<span class="badge bg-primary">${size.name}${priceText}</span>`;
        }).join('');
        input.value = JSON.stringify(selectedSizes);
    } else {
        container.style.display = 'none';
        input.value = '';
    }
}
</script>

