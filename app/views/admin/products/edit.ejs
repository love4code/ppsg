<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-pencil"></i> Edit Product</h2>
    <a href="/admin/products" class="btn btn-outline-secondary">Back to Products</a>
</div>

<div class="card">
    <div class="card-body">
        <form action="/admin/products/<%= product._id %>?_method=PUT" method="POST">
            <div class="mb-3">
                <label for="name" class="form-label">Product Name *</label>
                <input type="text" class="form-control" id="name" name="name" value="<%= product.name %>" required>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description *</label>
                <textarea class="form-control" id="description" name="description" rows="6" required><%= product.description %></textarea>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="price" class="form-label">Base Price (Optional)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="<%= product.price || '' %>">
                    </div>
                    <small class="form-text text-muted">Leave blank if using sizes only</small>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="isTaxable" class="form-label">Tax Status</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="isTaxable" name="isTaxable" <%= product.isTaxable ? 'checked' : '' %>>
                        <label class="form-check-label" for="isTaxable">Taxable</label>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="draft" <%= product.status === 'draft' ? 'selected' : '' %>>Draft</option>
                        <option value="published" <%= product.status === 'published' ? 'selected' : '' %>>Published</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="startingAtPrice" class="form-label">Starting At Price (Optional)</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="startingAtPrice" name="startingAtPrice" step="0.01" min="0" value="<%= product.startingAtPrice || '' %>">
                    </div>
                    <small class="form-text text-muted">Display price (e.g., "Starting at $X")</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="manufacturer" class="form-label">Manufacturer</label>
                    <input type="text" class="form-control" id="manufacturer" name="manufacturer" value="<%= product.manufacturer || '' %>" placeholder="e.g., Hayward, Pentair">
                </div>
            </div>

            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="materials" class="form-label">Materials Pool is Made Of</label>
                    <input type="text" class="form-control" id="materials" name="materials" value="<%= product.materials || '' %>" placeholder="e.g., Vinyl, Fiberglass, Concrete">
                    <small class="form-text text-muted">Comma-separated list of materials</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="saltwaterCompatible" class="form-label">Saltwater Compatible</label>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="saltwaterCompatible" name="saltwaterCompatible" <%= product.saltwaterCompatible ? 'checked' : '' %>>
                        <label class="form-check-label" for="saltwaterCompatible">Yes, saltwater compatible</label>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="mainImage" class="form-label">Main Image</label>
                    <input type="hidden" id="mainImage" name="mainImage" value="<%= product.mainImage ? product.mainImage._id : '' %>">
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#mediaPickerModal" onclick="setMediaPickerMode('single', 'mainImage')">
                            <i class="bi bi-images"></i> Choose from Media Library
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="clearMainImage" <%= product.mainImage ? '' : 'style="display: none;"' %> onclick="clearMainImage()">
                            <i class="bi bi-x"></i> Clear
                        </button>
                    </div>
                    <div id="mainImagePreview" class="mt-2">
                        <% if (product.mainImage) { %>
                            <img src="/admin/media/image/<%= product.mainImage._id %>/small" class="img-thumbnail" style="max-width: 200px;">
                        <% } %>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="gallery" class="form-label">Gallery Images</label>
                    <input type="hidden" id="gallery" name="gallery" value="<%= product.gallery && product.gallery.length > 0 ? product.gallery.map(g => g._id).join(',') : '' %>">
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#mediaPickerModal" onclick="setMediaPickerMode('multiple', 'gallery')">
                            <i class="bi bi-images"></i> Choose from Media Library
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="clearGallery" <%= product.gallery && product.gallery.length > 0 ? '' : 'style="display: none;"' %> onclick="clearGallery()">
                            <i class="bi bi-x"></i> Clear All
                        </button>
                    </div>
                    <div id="galleryPreview" class="mt-2 d-flex flex-wrap gap-2">
                        <% if (product.gallery && product.gallery.length > 0) { %>
                            <% product.gallery.forEach(galleryItem => { %>
                                <div class="position-relative" style="width: 100px;">
                                    <img src="/admin/media/image/<%= galleryItem._id %>/small" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" onclick="removeGalleryImage('<%= galleryItem._id %>')" style="padding: 2px 6px;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>
                    <small class="form-text text-muted">Select multiple images for the gallery</small>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Product Sizes</label>
                <div id="sizesContainer">
                    <% if (product.sizes && product.sizes.length > 0) { %>
                        <% product.sizes.forEach((size, index) => { %>
                            <div class="card mb-2" id="size-<%= index %>">
                                <div class="card-body p-3">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" name="sizes[<%= index %>][name]" value="<%= size.name %>" placeholder="Size name (e.g., Small)" required>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" name="sizes[<%= index %>][price]" step="0.01" min="0" value="<%= size.price || '' %>" placeholder="Price (optional)">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <input type="text" class="form-control" name="sizes[<%= index %>][description]" value="<%= size.description || '' %>" placeholder="Description (optional)">
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-outline-danger w-100" onclick="removeSizeField(<%= index %>)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addSizeField()">
                    <i class="bi bi-plus"></i> Add Size
                </button>
                <small class="form-text text-muted d-block">Add different sizes with optional prices (e.g., Small, Medium, Large)</small>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Update Product</button>
                <a href="/admin/products" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<!-- Media Library Picker Modal -->
<div class="modal fade" id="mediaPickerModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select from Media Library</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="mediaSearch" class="form-control" placeholder="Search images...">
                </div>
                <div class="row g-3" id="mediaGrid" style="max-height: 500px; overflow-y: auto;">
                    <!-- Media items will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmMediaSelection" onclick="confirmMediaSelection()">Select</button>
            </div>
        </div>
    </div>
</div>

<script>
let mediaPickerMode = 'single'; // 'single' or 'multiple'
let mediaPickerTarget = 'mainImage'; // 'mainImage' or 'gallery'
let selectedMediaItems = [];
let allMedia = [];

// Initialize with existing selections
document.addEventListener('DOMContentLoaded', function() {
    const mainImageId = document.getElementById('mainImage').value;
    const galleryIds = document.getElementById('gallery').value ? document.getElementById('gallery').value.split(',') : [];
    
    if (mainImageId) {
        selectedMediaItems = [{ _id: mainImageId }];
    }
});

// Load media on modal open
document.getElementById('mediaPickerModal').addEventListener('show.bs.modal', function() {
    loadMediaLibrary();
    // Pre-select existing items
    if (mediaPickerTarget === 'mainImage') {
        const mainImageId = document.getElementById('mainImage').value;
        if (mainImageId) {
            selectedMediaItems = [{ _id: mainImageId }];
        } else {
            selectedMediaItems = [];
        }
    } else if (mediaPickerTarget === 'gallery') {
        const galleryIds = document.getElementById('gallery').value ? document.getElementById('gallery').value.split(',') : [];
        selectedMediaItems = galleryIds.map(id => ({ _id: id }));
    }
    loadMediaLibrary();
});

function setMediaPickerMode(mode, target) {
    mediaPickerMode = mode;
    mediaPickerTarget = target;
    
    // Pre-select existing items based on target
    if (target === 'mainImage') {
        const mainImageId = document.getElementById('mainImage').value;
        selectedMediaItems = mainImageId ? [{ _id: mainImageId }] : [];
    } else if (target === 'gallery') {
        const galleryIds = document.getElementById('gallery').value ? document.getElementById('gallery').value.split(',') : [];
        selectedMediaItems = galleryIds.map(id => ({ _id: id }));
    }
}

async function loadMediaLibrary() {
    try {
        const response = await fetch('/admin/api/media');
        allMedia = await response.json();
        renderMediaGrid(allMedia);
        updateConfirmButton();
    } catch (error) {
        console.error('Error loading media:', error);
        document.getElementById('mediaGrid').innerHTML = '<div class="col-12"><p class="text-danger">Error loading media library</p></div>';
    }
}

function renderMediaGrid(media) {
    const grid = document.getElementById('mediaGrid');
    if (!media || media.length === 0) {
        grid.innerHTML = '<div class="col-12"><p class="text-muted text-center">No media found</p></div>';
        return;
    }
    
    grid.innerHTML = media.map(item => {
        const isSelected = selectedMediaItems.some(selected => selected._id === item._id);
        return `
            <div class="col-md-3 col-sm-4 col-6">
                <div class="card media-item ${isSelected ? 'border-primary border-3' : ''}" 
                     onclick="toggleMediaSelection('${item._id}')" 
                     style="cursor: pointer;">
                    <img src="/admin/media/image/${item._id}/small" 
                         class="card-img-top" 
                         alt="${item.altText || item.title || item.originalFilename}"
                         style="height: 150px; object-fit: cover;">
                    <div class="card-body p-2">
                        <p class="card-text small mb-0 text-truncate" title="${item.originalFilename}">
                            ${item.originalFilename}
                        </p>
                        ${isSelected ? '<i class="bi bi-check-circle-fill text-primary position-absolute top-0 end-0 m-2" style="font-size: 1.5rem;"></i>' : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleMediaSelection(mediaId) {
    const index = selectedMediaItems.findIndex(item => item._id === mediaId);
    const mediaItem = allMedia.find(item => item._id === mediaId);
    
    if (mediaPickerMode === 'single') {
        selectedMediaItems = mediaItem ? [mediaItem] : [];
    } else {
        if (index > -1) {
            selectedMediaItems.splice(index, 1);
        } else {
            if (mediaItem) {
                selectedMediaItems.push(mediaItem);
            }
        }
    }
    
    renderMediaGrid(allMedia);
    updateConfirmButton();
}

function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmMediaSelection');
    if (mediaPickerMode === 'multiple') {
        confirmBtn.textContent = 'Select (' + selectedMediaItems.length + ')';
    } else {
        confirmBtn.textContent = 'Select';
        confirmBtn.disabled = selectedMediaItems.length === 0;
    }
}

function confirmMediaSelection() {
    if (selectedMediaItems.length === 0 && mediaPickerMode === 'single') return;
    
    if (mediaPickerTarget === 'mainImage') {
        if (selectedMediaItems.length > 0) {
            const mediaId = selectedMediaItems[0]._id;
            document.getElementById('mainImage').value = mediaId;
            updateMainImagePreview(mediaId);
            document.getElementById('clearMainImage').style.display = 'inline-block';
        } else {
            document.getElementById('mainImage').value = '';
            document.getElementById('mainImagePreview').innerHTML = '';
            document.getElementById('clearMainImage').style.display = 'none';
        }
    } else if (mediaPickerTarget === 'gallery') {
        const galleryIds = selectedMediaItems.map(item => item._id);
        document.getElementById('gallery').value = galleryIds.join(',');
        updateGalleryPreview(galleryIds);
        document.getElementById('clearGallery').style.display = galleryIds.length > 0 ? 'inline-block' : 'none';
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('mediaPickerModal'));
    modal.hide();
}

function updateMainImagePreview(mediaId) {
    const preview = document.getElementById('mainImagePreview');
    preview.innerHTML = `<img src="/admin/media/image/${mediaId}/small" class="img-thumbnail" style="max-width: 200px;">`;
}

function updateGalleryPreview(mediaIds) {
    const preview = document.getElementById('galleryPreview');
    if (mediaIds.length === 0) {
        preview.innerHTML = '';
        return;
    }
    
    preview.innerHTML = mediaIds.map(id => {
        return `
            <div class="position-relative" style="width: 100px;">
                <img src="/admin/media/image/${id}/small" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;">
                <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" onclick="removeGalleryImage('${id}')" style="padding: 2px 6px;">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
    }).join('');
}

function removeGalleryImage(mediaId) {
    const galleryInput = document.getElementById('gallery');
    const currentIds = galleryInput.value ? galleryInput.value.split(',') : [];
    const newIds = currentIds.filter(id => id !== mediaId);
    galleryInput.value = newIds.join(',');
    updateGalleryPreview(newIds);
    document.getElementById('clearGallery').style.display = newIds.length > 0 ? 'inline-block' : 'none';
}

function clearMainImage() {
    document.getElementById('mainImage').value = '';
    document.getElementById('mainImagePreview').innerHTML = '';
    document.getElementById('clearMainImage').style.display = 'none';
}

function clearGallery() {
    document.getElementById('gallery').value = '';
    document.getElementById('galleryPreview').innerHTML = '';
    document.getElementById('clearGallery').style.display = 'none';
}

// Search functionality
document.getElementById('mediaSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const filtered = allMedia.filter(item => 
        item.originalFilename.toLowerCase().includes(searchTerm) ||
        (item.title && item.title.toLowerCase().includes(searchTerm)) ||
        (item.altText && item.altText.toLowerCase().includes(searchTerm))
    );
    renderMediaGrid(filtered);
});

// Size management
let sizeCounter = <%= product.sizes ? product.sizes.length : 0 %>;

function addSizeField() {
    const container = document.getElementById('sizesContainer');
    const sizeDiv = document.createElement('div');
    sizeDiv.className = 'card mb-2';
    sizeDiv.id = `size-${sizeCounter}`;
    sizeDiv.innerHTML = `
        <div class="card-body p-3">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="sizes[${sizeCounter}][name]" placeholder="Size name (e.g., Small)" required>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" name="sizes[${sizeCounter}][price]" step="0.01" min="0" placeholder="Price (optional)">
                    </div>
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" name="sizes[${sizeCounter}][description]" placeholder="Description (optional)">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-outline-danger w-100" onclick="removeSizeField(${sizeCounter})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    container.appendChild(sizeDiv);
    sizeCounter++;
}

function removeSizeField(index) {
    const sizeDiv = document.getElementById(`size-${index}`);
    if (sizeDiv) {
        sizeDiv.remove();
    }
}
</script>

